{% extends "layouts/base.html" %}

{% block title %}任务调度 - 智能管理系统{% endblock %}

{% block content %}
<el-card class="page-header-card">
    <div class="page-header">
        <h1>任务调度</h1>
        <p>创建和管理定时任务，自动化执行重复性工作</p>
    </div>
</el-card>

<el-card class="tasks-management-card">
    <div slot="header" class="tasks-header">
        <h2>任务列表</h2>
        <div class="task-controls">
            <el-input 
                v-model="searchQuery" 
                placeholder="搜索任务..." 
                prefix-icon="fa fa-search"
                style="width: 200px; margin-right: 10px;"
            ></el-input>
            <el-button type="primary" @click="showTaskDialog = true; isEditing = false; resetTaskForm();">
                <i class="fa fa-plus"></i> 添加任务
            </el-button>
        </div>
    </div>
    
    <!-- 任务类型筛选 -->
    <div class="task-filters">
        <el-radio-group v-model="taskTypeFilter" @change="filterTasks">
            <el-radio-button label="all">全部任务</el-radio-button>
            <el-radio-button label="once">一次性任务</el-radio-button>
            <el-radio-button label="scheduled">定时任务</el-radio-button>
            <el-radio-button label="interval">间隔任务</el-radio-button>
        </el-radio-group>
        
        <el-radio-group v-model="taskStatusFilter" @change="filterTasks" style="margin-left: 15px;">
            <el-radio-button label="all">全部状态</el-radio-button>
            <el-radio-button label="running">运行中</el-radio-button>
            <el-radio-button label="paused">已暂停</el-radio-button>
            <el-radio-button label="pending">未开始</el-radio-button>
            <el-radio-button label="completed">已完成</el-radio-button>
        </el-radio-group>
    </div>
    
    <!-- 任务列表 -->
    <el-table 
        :data="filteredTasks" 
        border 
        style="width: 100%; margin-top: 15px;"
        :row-class-name="taskRowClassName"
    >
        <el-table-column 
            prop="id" 
            label="ID" 
            width="100"
            align="center"
        ></el-table-column>
        <el-table-column 
            prop="name" 
            label="任务名称" 
            width="200"
        ></el-table-column>
        <el-table-column 
            prop="description" 
            label="描述"
        ></el-table-column>
        <el-table-column 
            prop="type" 
            label="类型" 
            width="120"
            align="center"
        >
            <template #default="scope">
                <el-tag 
                    :type="scope.row.type === 'once' ? 'primary' : 
                           scope.row.type === 'scheduled' ? 'success' : 'info'"
                >
                    {{ scope.row.type === 'once' ? '一次性' : 
                       scope.row.type === 'scheduled' ? '定时' : '间隔' }}
                </el-tag>
            </template>
        </el-table-column>
        <el-table-column 
            prop="schedule" 
            label="调度信息"
        >
            <template #default="scope">
                <template v-if="scope.row.type === 'once'">
                    {{ formatDateTime(scope.row.executionTime) }}
                </template>
                <template v-if="scope.row.type === 'scheduled'">
                    <div>
                        <span>Cron: {{ scope.row.cronExpression }}</span>
                        <el-tooltip effect="dark" :content="formatCron(scope.row.cronExpression)" placement="top">
                            <i class="fa fa-question-circle" style="margin-left: 5px; color: var(--text-color-secondary);"></i>
                        </el-tooltip>
                    </div>
                </template>
                <template v-if="scope.row.type === 'interval'">
                    每 {{ scope.row.intervalValue }} {{ 
                        scope.row.intervalUnit === 'seconds' ? '秒' : 
                        scope.row.intervalUnit === 'minutes' ? '分钟' : 
                        scope.row.intervalUnit === 'hours' ? '小时' : '天' 
                    }}
                </template>
            </template>
        </el-table-column>
        <el-table-column 
            prop="status" 
            label="状态" 
            width="120"
            align="center"
        >
            <template #default="scope">
                <el-tag 
                    :type="getStatusType(scope.row.status)"
                >
                    {{ getStatusText(scope.row.status) }}
                </el-tag>
            </template>
        </el-table-column>
        <el-table-column 
            prop="createdAt" 
            label="创建时间" 
            width="180"
            align="center"
        >
            <template #default="scope">
                {{ formatDateTime(scope.row.createdAt) }}
            </template>
        </el-table-column>
        <el-table-column 
            label="操作" 
            width="300"
            align="center"
        >
            <template #default="scope">
                <el-button 
                    size="small" 
                    @click="handleStartTask(scope.row)"
                    :disabled="!canStartTask(scope.row.status)"
                >
                    开始
                </el-button>
                <el-button 
                    size="small" 
                    @click="handlePauseTask(scope.row)"
                    :disabled="!canPauseTask(scope.row.status)"
                >
                    暂停
                </el-button>
                <el-button 
                    size="small" 
                    @click="handleEditTask(scope.row)"
                >
                    编辑
                </el-button>
                <el-button 
                    size="small" 
                    type="danger" 
                    @click="handleDeleteTask(scope.row.id)"
                >
                    删除
                </el-button>
            </template>
        </el-table-column>
    </el-table>
    
    <!-- 分页 -->
    <div class="pagination-container">
        <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="currentPage"
            :page-sizes="[10, 20, 50]"
            :page-size="pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="filteredTasks.length"
        ></el-pagination>
    </div>
</el-card>

<!-- 任务执行日志 -->
<el-card class="task-logs-card">
    <div slot="header">
        <h2>任务执行日志</h2>
    </div>
    
    <el-table 
        :data="taskLogs" 
        border 
        style="width: 100%;"
    >
        <el-table-column 
            prop="id" 
            label="ID" 
            width="100"
            align="center"
        ></el-table-column>
        <el-table-column 
            prop="task_name" 
            label="任务名称" 
            width="200"
        ></el-table-column>
        <el-table-column 
            prop="start_time" 
            label="执行时间" 
            width="180"
            align="center"
        >
            <template #default="scope">
                {{ formatDateTime(scope.row.start_time) }}
            </template>
        </el-table-column>
        <el-table-column 
            prop="status" 
            label="状态" 
            width="100"
            align="center"
        >
            <template #default="scope">
                <el-tag :type="scope.row.status === 'completed' ? 'success' : 'danger'">
                    {{ scope.row.status === 'completed' ? '成功' : '失败' }}
                </el-tag>
            </template>
        </el-table-column>
    </el-table>
</el-card>

<!-- 任务对话框 -->
<el-dialog 
    :title="isEditing ? '编辑任务' : '添加新任务'" 
    :visible.sync="showTaskDialog" 
    width="600px"
>
    <el-form 
        :model="currentTask" 
        ref="taskForm" 
        :rules="taskRules"
        label-width="120px"
    >
        <el-form-item label="任务名称" prop="name">
            <el-input v-model="currentTask.name"></el-input>
        </el-form-item>
        <el-form-item label="任务描述" prop="description">
            <el-input 
                v-model="currentTask.description" 
                type="textarea" 
                rows="3"
            ></el-input>
        </el-form-item>
        <el-form-item label="任务类型" prop="type">
            <el-select v-model="currentTask.type" placeholder="请选择任务类型" @change="handleTaskTypeChange">
                <el-option label="一次性任务" value="once"></el-option>
                <el-option label="定时任务" value="scheduled"></el-option>
                <el-option label="间隔任务" value="interval"></el-option>
            </el-select>
        </el-form-item>
        
        <!-- 一次性任务设置 -->
        <el-form-item label="执行时间" v-if="currentTask.type === 'once'" prop="executionTime">
            <el-date-picker
                v-model="currentTask.executionTime"
                type="datetime"
                placeholder="选择执行时间"
                style="width: 100%;"
            ></el-date-picker>
        </el-form-item>
        
        <!-- 定时任务设置 -->
        <el-form-item label="Cron表达式" v-if="currentTask.type === 'scheduled'" prop="cronExpression">
            <el-input v-model="currentTask.cronExpression" placeholder="例如: 0 0 * * * 表示每天凌晨执行"></el-input>
            <el-tooltip class="item" effect="dark" content="Cron表达式格式: 分 时 日 月 周" placement="top">
                <i class="fa fa-question-circle" style="margin-top: 5px;"></i>
            </el-tooltip>
            <div class="cron-examples" v-if="currentTask.type === 'scheduled'">
                <p style="margin-top: 10px; font-weight: 500;">常用示例:</p>
                <el-tag 
                    v-for="(example, key) in cronExamples" 
                    :key="key"
                    @click="currentTask.cronExpression = key"
                    style="margin-right: 5px; margin-bottom: 5px; cursor: pointer;"
                >
                    {{ example }}
                </el-tag>
            </div>
        </el-form-item>
        
        <!-- 间隔任务设置 -->
        <el-form-item label="间隔时间" v-if="currentTask.type === 'interval'">
            <el-form-item prop="intervalValue" style="margin-bottom: 0;">
                <el-input-number 
                    v-model="currentTask.intervalValue" 
                    :min="1" 
                    label="数值"
                    style="width: 120px;"
                ></el-input-number>
            </el-form-item>
            <el-form-item prop="intervalUnit" style="margin-bottom: 0; margin-left: 10px;">
                <el-select v-model="currentTask.intervalUnit" style="width: 120px;">
                    <el-option label="秒" value="seconds"></el-option>
                    <el-option label="分钟" value="minutes"></el-option>
                    <el-option label="小时" value="hours"></el-option>
                    <el-option label="天" value="days"></el-option>
                </el-select>
            </el-form-item>
        </el-form-item>
    </el-form>
    <div slot="footer" class="dialog-footer">
        <el-button @click="showTaskDialog = false">取消</el-button>
        <el-button type="primary" @click="saveTask">
            <template v-if="isEditing">确认修改</template>
            <template v-else>确认添加</template>
        </el-button>
    </div>
</el-dialog>
{% endblock %}

{% block extra_js %}
<script>
// 任务调度页面的Vue代码
app._context.config.globalProperties.data = function() {
    return {
        // 任务数据
        tasks: [],
        taskLogs: [],
        
        // 筛选和分页
        searchQuery: '',
        taskTypeFilter: 'all',
        taskStatusFilter: 'all',
        filteredTasks: [],
        currentPage: 1,
        pageSize: 10,
        
        // 对话框状态
        showTaskDialog: false,
        isEditing: false,
        
        // 当前任务表单数据
        currentTask: {
            id: null,
            name: "",
            description: "",
            type: "once",
            executionTime: new Date(),
            cronExpression: "0 0 * * *",
            intervalValue: 1,
            intervalUnit: "hours",
            status: "pending",
            progress: 0,
            createdAt: ""
        },
        
        // Cron表达式示例
        cronExamples: {
            "0 * * * *": "每小时",
            "0 0 * * *": "每天凌晨",
            "0 0 * * 0": "每周日凌晨",
            "0 0 1 * *": "每月1日凌晨",
            "*/30 * * * *": "每30分钟"
        },
        
        // 表单验证规则
        taskRules: {
            name: [
                { required: true, message: '请输入任务名称', trigger: 'blur' },
                { min: 2, max: 50, message: '长度在 2 到 50 个字符', trigger: 'blur' }
            ],
            description: [
                { max: 200, message: '描述不能超过200个字符', trigger: 'blur' }
            ],
            cronExpression: [
                { required: true, message: '请输入Cron表达式', trigger: 'blur' }
            ],
            executionTime: [
                { required: true, message: '请选择执行时间', trigger: 'change' }
            ],
            intervalValue: [
                { required: true, message: '请输入间隔数值', trigger: 'blur' },
                { type: 'number', min: 1, message: '间隔数值必须大于0', trigger: 'blur' }
            ],
            intervalUnit: [
                { required: true, message: '请选择间隔单位', trigger: 'change' }
            ]
        }
    };
};

// 添加方法
app._context.config.globalProperties.methods = {
    // 页面加载时获取任务列表
    async mounted() {
        await this.loadTasks();
        await this.loadTaskLogs();
    },
    
    // 从API加载任务
    async loadTasks() {
        try {
            const response = await fetch('/api/tasks');
            if (response.ok) {
                this.tasks = await response.json();
                this.filterTasks();
            }
        } catch (error) {
            console.error('加载任务失败:', error);
            this.$message.error('加载任务失败');
        }
    },
    
    // 从API加载任务日志
    async loadTaskLogs() {
        try {
            const response = await fetch('/api/tasks/logs');
            if (response.ok) {
                this.taskLogs = await response.json();
            }
        } catch (error) {
            console.error('加载任务日志失败:', error);
            this.$message.error('加载任务日志失败');
        }
    },
    
    // 筛选任务
    filterTasks() {
        let result = [...this.tasks];
        
        // 按搜索词筛选
        if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            result = result.filter(task => 
                task.name.toLowerCase().includes(query) || 
                task.description.toLowerCase().includes(query)
            );
        }
        
        // 按任务类型筛选
        if (this.taskTypeFilter !== 'all') {
            result = result.filter(task => task.type === this.taskTypeFilter);
        }
        
        // 按任务状态筛选
        if (this.taskStatusFilter !== 'all') {
            result = result.filter(task => task.status === this.taskStatusFilter);
        }
        
        this.filteredTasks = result;
        this.currentPage = 1; // 重置到第一页
    },
    
    // 处理分页大小变化
    handleSizeChange(val) {
        this.pageSize = val;
        this.currentPage = 1;
    },
    
    // 处理当前页变化
    handleCurrentChange(val) {
        this.currentPage = val;
    },
    
    // 任务行样式
    taskRowClassName({ row }) {
        if (row.status === 'completed') {
            return 'task-completed';
        }
        return '';
    },
    
    // 获取任务状态类型
    getStatusType(status) {
        switch(status) {
            case 'running': return 'success';
            case 'paused': return 'warning';
            case 'completed': return 'info';
            case 'failed': return 'danger';
            default: return 'primary';
        }
    },
    
    // 获取任务状态文本
    getStatusText(status) {
        switch(status) {
            case 'running': return '运行中';
            case 'paused': return '已暂停';
            case 'completed': return '已完成';
            case 'failed': return '已失败';
            case 'pending': return '未开始';
            default: return '未知';
        }
    },
    
    // 判断是否可以开始任务
    canStartTask(status) {
        return status === 'pending' || status === 'paused' || status === 'failed';
    },
    
    // 判断是否可以暂停任务
    canPauseTask(status) {
        return status === 'running';
    },
    
    // 格式化日期时间
    formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString();
    },
    
    // 格式化Cron表达式
    formatCron(expr) {
        if (!expr) return "无效表达式";
        
        const parts = expr.split(' ');
        if (parts.length !== 5) return "无效表达式";
        
        const [minute, hour, day, month, weekday] = parts;
        
        let result = '';
        
        // 处理分钟
        if (minute === '*') result += '每分钟 ';
        else if (minute.startsWith('*/')) result += `每${minute.slice(2)}分钟 `;
        else result += `${minute}分 `;
        
        // 处理小时
        if (hour === '*') result += '每小时 ';
        else if (hour.startsWith('*/')) result += `每${hour.slice(2)}小时 `;
        else result += `${hour}时 `;
        
        // 处理日期和星期
        if (day === '*' && weekday === '*') result += '每天 ';
        else if (day !== '*') result += `${day}日 `;
        else if (weekday !== '*') {
            if (weekday.startsWith('*/')) result += `每${weekday.slice(2)}周 `;
            else {
                const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                result += `${weekdays[parseInt(weekday)]} `;
            }
        }
        
        // 处理月份
        if (month === '*') result += '每月';
        else if (month.startsWith('*/')) result += `每${month.slice(2)}月`;
        else result += `${month}月`;
        
        return result;
    },
    
    // 开始任务
    async handleStartTask(task) {
        try {
            const response = await fetch(`/api/tasks/${task.id}/start`, {
                method: 'POST'
            });
            
            if (response.ok) {
                task.status = 'running';
                this.$message.success(`任务 "${task.name}" 已开始`);
                
                // 模拟进度更新
                if (task.progress < 100) {
                    this.simulateTaskProgress(task);
                }
            } else {
                this.$message.error('启动任务失败');
            }
        } catch (error) {
            console.error('启动任务失败:', error);
            this.$message.error('启动任务失败');
        }
    },
    
    // 暂停任务
    async handlePauseTask(task) {
        try {
            const response = await fetch(`/api/tasks/${task.id}/pause`, {
                method: 'POST'
            });
            
            if (response.ok) {
                task.status = 'paused';
                this.$message.warning(`任务 "${task.name}" 已暂停`);
            } else {
                this.$message.error('暂停任务失败');
            }
        } catch (error) {
            console.error('暂停任务失败:', error);
            this.$message.error('暂停任务失败');
        }
    },
    
    // 编辑任务
    handleEditTask(task) {
        // 深拷贝任务数据
        this.currentTask = JSON.parse(JSON.stringify(task));
        
        // 处理日期格式
        if (task.executionTime) {
            this.currentTask.executionTime = new Date(task.executionTime);
        }
        
        this.isEditing = true;
        this.showTaskDialog = true;
    },
    
    // 删除任务
    async handleDeleteTask(taskId) {
        this.$confirm('确定要删除这个任务吗?', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
        }).then(async () => {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    this.tasks = this.tasks.filter(task => task.id !== taskId);
                    this.filterTasks();
                    this.$message.success('任务已删除');
                } else {
                    this.$message.error('删除任务失败');
                }
            } catch (error) {
                console.error('删除任务失败:', error);
                this.$message.error('删除任务失败');
            }
        });
    },
    
    // 重置任务表单
    resetTaskForm() {
        this.currentTask = {
            id: null,
            name: "",
            description: "",
            type: "once",
            executionTime: new Date(),
            cronExpression: "0 0 * * *",
            intervalValue: 1,
            intervalUnit: "hours",
            status: "pending",
            progress: 0,
            createdAt: ""
        };
        
        if (this.$refs.taskForm) {
            this.$refs.taskForm.resetFields();
        }
    },
    
    // 任务类型改变时的处理
    handleTaskTypeChange() {
        // 根据任务类型重置相关字段
        if (this.currentTask.type === 'once') {
            this.currentTask.executionTime = new Date();
        } else if (this.currentTask.type === 'scheduled') {
            this.currentTask.cronExpression = "0 0 * * *";
        } else if (this.currentTask.type === 'interval') {
            this.currentTask.intervalValue = 1;
            this.currentTask.intervalUnit = "hours";
        }
    },
    
    // 保存任务（新增或修改）
    async saveTask() {
        this.$refs.taskForm.validate(async (valid) => {
            if (valid) {
                try {
                    let response;
                    const taskData = {
                        name: this.currentTask.name,
                        description: this.currentTask.description,
                        type: this.currentTask.type,
                        executionTime: this.currentTask.executionTime ? this.currentTask.executionTime.toISOString() : null,
                        cronExpression: this.currentTask.cronExpression,
                        intervalValue: this.currentTask.intervalValue,
                        intervalUnit: this.currentTask.intervalUnit
                    };
                    
                    if (this.isEditing) {
                        // 更新现有任务
                        response = await fetch(`/api/tasks/${this.currentTask.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(taskData)
                        });
                    } else {
                        // 创建新任务
                        response = await fetch('/api/tasks', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(taskData)
                        });
                    }
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showTaskDialog = false;
                        this.loadTasks(); // 重新加载任务列表
                        
                        if (this.isEditing) {
                            this.$message.success('任务已更新');
                        } else {
                            this.$message.success('任务已添加');
                        }
                    } else {
                        this.$message.error(this.isEditing ? '更新任务失败' : '添加任务失败');
                    }
                } catch (error) {
                    console.error('保存任务失败:', error);
                    this.$message.error('保存任务失败');
                }
            }
        });
    },
    
    // 模拟任务进度更新
    simulateTaskProgress(task) {
        if (task.status !== 'running') return;
        
        const interval = setInterval(() => {
            // 检查任务是否仍在运行
            const currentTask = this.tasks.find(t => t.id === task.id);
            if (!currentTask || currentTask.status !== 'running') {
                clearInterval(interval);
                return;
            }
            
            // 随机增加进度
            currentTask.progress += Math.floor(Math.random() * 5) + 1;
            
            // 如果进度达到100%，标记为已完成
            if (currentTask.progress >= 100) {
                currentTask.progress = 100;
                currentTask.status = 'completed';
                clearInterval(interval);
                
                this.$message.success(`任务 "${currentTask.name}" 已完成`);
                
                // 通知后端任务已完成
                fetch(`/api/tasks/${currentTask.id}/complete`, {
                    method: 'POST'
                });
                
                // 刷新任务日志
                this.loadTaskLogs();
            }
        }, 1000);
    }
};
</script>
{% endblock %}

{% block extra_css %}
<style>
.page-header-card {
    margin-bottom: 20px;
}

.page-header {
    padding: 20px;
}

.page-header h1 {
    margin-bottom: 10px;
    font-size: 24px;
    font-weight: 600;
}

.page-header p {
    color: var(--text-color-secondary);
    font-size: 14px;
}

.tasks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.task-controls {
    display: flex;
    align-items: center;
}

.task-filters {
    display: flex;
    padding: 15px 20px 0;
    flex-wrap: wrap;
}

.pagination-container {
    margin-top: 20px;
    padding: 0 20px 20px;
}

.cron-examples {
    margin-top: 10px;
}

.task-logs-card {
    margin-top: 20px;
}

@media (max-width: 768px) {
    .tasks-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .task-controls {
        width: 100%;
        margin-top: 10px;
    }
    
    .el-input {
        width: 100% !important;
        margin-right: 0 !important;
        margin-bottom: 10px;
    }
    
    .task-filters {
        flex-direction: column;
    }
    
    .el-radio-group {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .el-radio-group:last-child {
        margin-left: 0 !important;
    }
}
</style>
{% endblock %}