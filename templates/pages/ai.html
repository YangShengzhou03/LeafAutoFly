{% extends "layouts/base.html" %}

{% block title %}AI助手 - 智能管理系统{% endblock %}

{% block content %}
<el-card class="page-header-card">
    <div class="page-header">
        <h1>AI助手</h1>
        <p>智能AI助手可以帮助你管理任务、回答问题和提供建议</p>
    </div>
</el-card>

<el-card class="ai-card">
    <div slot="header">
        <h2>AI对话</h2>
        <div class="ai-controls">
            <el-button 
                size="small" 
                @click="clearConversation"
                icon="fa fa-trash-o"
            >
                清除对话
            </el-button>
        </div>
    </div>
    
    <div class="ai-container">
        <!-- AI消息区域 -->
        <div class="ai-messages">
            <div v-if="conversations.length === 0" class="empty-conversation">
                <div class="empty-icon">
                    <i class="fa fa-comments-o"></i>
                </div>
                <p>开始与AI助手对话吧</p>
                <p class="hint-text">你可以询问关于任务管理的问题，或者让AI帮你创建任务</p>
            </div>
            
            <div 
                v-for="msg in conversations" 
                :key="msg.id" 
                :class="['ai-message', msg.sender]"
            >
                <div class="message-bubble">
                    {{ msg.content }}
                </div>
                <div class="message-time">
                    {{ formatTime(msg.timestamp) }}
                </div>
            </div>
            
            <!-- 加载中状态 -->
            <div v-if="isLoading" class="ai-message ai loading">
                <div class="message-bubble">
                    <div class="loading-indicator">
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        <span>AI正在思考...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 输入区域 -->
        <div class="ai-input-area">
            <el-input 
                v-model="message" 
                placeholder="输入消息..." 
                @keyup.enter.native="sendMessage"
                :disabled="isLoading"
            ></el-input>
            <el-button 
                type="primary" 
                @click="sendMessage"
                :loading="isLoading"
            >
                发送
            </el-button>
        </div>
    </div>
</el-card>

<el-card class="ai-features-card">
    <div slot="header">
        <h2>AI能力</h2>
    </div>
    
    <div class="features-grid">
        <el-card class="feature-item">
            <div class="feature-icon">
                <i class="fa fa-tasks"></i>
            </div>
            <h3>任务管理</h3>
            <p>帮助你创建、管理和优化任务计划</p>
            <div class="example-commands">
                <p>示例指令:</p>
                <ul>
                    <li>"创建一个每天备份数据的任务"</li>
                    <li>"帮我设置一个每小时运行的脚本"</li>
                    <li>"优化我的任务调度"</li>
                </ul>
            </div>
        </el-card>
        
        <el-card class="feature-item">
            <div class="feature-icon">
                <i class="fa fa-question-circle"></i>
            </div>
            <h3>问题解答</h3>
            <p>回答关于系统使用和任务调度的问题</p>
            <div class="example-commands">
                <p>示例指令:</p>
                <ul>
                    <li>"什么是Cron表达式?"</li>
                    <li>"如何设置定时任务?"</li>
                    <li>"间隔任务和定时任务的区别"</li>
                </ul>
            </div>
        </el-card>
        
        <el-card class="feature-item">
            <div class="feature-icon">
                <i class="fa fa-lightbulb-o"></i>
            </div>
            <h3>智能建议</h3>
            <p>根据你的使用习惯提供个性化建议</p>
            <div class="example-commands">
                <p>示例指令:</p>
                <ul>
                    <li>"给我一些自动化建议"</li>
                    <li>"如何优化我的任务执行效率"</li>
                    <li>"帮我分析任务执行情况"</li>
                </ul>
            </div>
        </el-card>
    </div>
</el-card>
{% endblock %}

{% block extra_js %}
<script>
// AI助手页面的Vue代码
app._context.config.globalProperties.data = function() {
    return {
        // 对话数据
        conversations: [],
        message: "",
        isLoading: false
    };
};

// 添加方法
app._context.config.globalProperties.methods = {
    // 页面加载时获取对话历史
    async mounted() {
        await this.loadConversations();
    },
    
    // 从API加载对话历史
    async loadConversations() {
        try {
            const response = await fetch('/api/ai/conversations');
            if (response.ok) {
                this.conversations = await response.json();
                this.scrollToBottom();
            }
        } catch (error) {
            console.error('加载对话历史失败:', error);
            this.$message.error('加载对话历史失败');
        }
    },
    
    // 发送消息
    async sendMessage() {
        if (!this.message.trim() || this.isLoading) return;
        
        const userMessage = this.message.trim();
        this.message = "";
        this.isLoading = true;
        
        try {
            const response = await fetch('/api/ai/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: userMessage })
            });
            
            if (response.ok) {
                await this.loadConversations();
            } else {
                this.$message.error('发送消息失败');
            }
        } catch (error) {
            console.error('发送消息失败:', error);
            this.$message.error('发送消息失败');
        } finally {
            this.isLoading = false;
            this.scrollToBottom();
        }
    },
    
    // 清除对话
    async clearConversation() {
        this.$confirm('确定要清除所有对话历史吗?', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
        }).then(async () => {
            try {
                const response = await fetch('/api/ai/conversations', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    this.conversations = [];
                    this.$message.success('对话历史已清除');
                } else {
                    this.$message.error('清除对话历史失败');
                }
            } catch (error) {
                console.error('清除对话历史失败:', error);
                this.$message.error('清除对话历史失败');
            }
        });
    },
    
    // 格式化时间
    formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
    },
    
    // 滚动到底部
    scrollToBottom() {
        this.$nextTick(() => {
            const messagesContainer = document.querySelector('.ai-messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });
    }
};
</script>
{% endblock %}

{% block extra_css %}
<style>
.page-header-card {
    margin-bottom: 20px;
}

.page-header {
    padding: 20px;
}

.page-header h1 {
    margin-bottom: 10px;
    font-size: 24px;
    font-weight: 600;
}

.page-header p {
    color: var(--text-color-secondary);
    font-size: 14px;
}

.ai-card {
    margin-bottom: 20px;
}

.ai-card .el-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ai-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.ai-messages {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    background-color: var(--background-color);
}

.empty-conversation {
    text-align: center;
    padding: 50px 0;
    color: var(--text-color-secondary);
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
    color: var(--text-color-secondary);
    opacity: 0.5;
}

.hint-text {
    font-size: 12px;
    margin-top: 5px;
    opacity: 0.8;
}

.ai-message {
    margin-bottom: 16px;
    max-width: 80%;
}

.ai-message.user {
    margin-left: auto;
}

.ai-message .message-bubble {
    padding: 10px 15px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.ai-message.ai .message-bubble {
    background-color: var(--card-background);
    border: 1px solid var(--border-color);
    border-top-left-radius: 4px;
}

.ai-message.user .message-bubble {
    background-color: var(--primary-color);
    color: white;
    border-top-right-radius: 4px;
}

.message-time {
    font-size: 12px;
    color: var(--text-color-secondary);
    margin-top: 4px;
    padding-left: 10px;
    padding-right: 10px;
}

.ai-message.user .message-time {
    text-align: right;
}

.loading-indicator {
    display: flex;
    align-items: center;
    color: var(--text-color-secondary);
}

.loading-indicator i {
    margin-right: 8px;
}

.ai-input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid var(--border-color);
    background-color: var(--card-background);
}

.ai-input-area .el-input {
    flex-grow: 1;
    margin-right: 10px;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    padding: 10px;
}

.feature-item {
    display: flex;
    flex-direction: column;
    padding: 20px;
    height: 100%;
}

.feature-icon {
    font-size: 32px;
    color: var(--primary-color);
    margin-bottom: 15px;
}

.feature-item h3 {
    margin-bottom: 10px;
    font-size: 16px;
    font-weight: 600;
}

.feature-item p {
    color: var(--text-color-secondary);
    margin-bottom: 15px;
    flex-grow: 1;
}

.example-commands {
    background-color: var(--background-color);
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
}

.example-commands p {
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--text-color);
}

.example-commands ul {
    padding-left: 20px;
    margin: 0;
}

.example-commands li {
    margin-bottom: 3px;
    color: var(--text-color-secondary);
}

@media (max-width: 768px) {
    .features-grid {
        grid-template-columns: 1fr;
    }
    
    .ai-message {
        max-width: 90%;
    }
}
</style>
{% endblock %}